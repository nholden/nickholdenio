<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tracking loans and payments between users | Nick Holden dot IO</title>
    <link href="../../../../stylesheets/all.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <script src="../../../../javascripts/all.js" type="text/javascript"></script>

    <!-- Google Analytics //-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-64216632-1', 'auto');
      ga('send', 'pageview');
    </script>

  </head>

  <body class="blog blog_2015 blog_2015_08 blog_2015_08_04 blog_2015_08_04_tracking-loans-and-payments-between-users">
    <div class="hero"></div>
    <div class="headshot">
<a href="/">        <img src="/images/headshot.png" alt="Nick Holden" />
</a>    </div>
    <div class="content">
  <article>
    <div class="left-column"><h2>Tracking loans and payments between users</h2></div>
    <div class="right-column">
      <p>Tools like Venmo and PayPal have made it easier to quickly send money to friends when cash isn't convenient. For folks like roommates, with whom you have a lot of shared costs each month, it may make more sense to keep track of what you owe each other over time and settle up on a regular interval, rather than making many smaller transactions.</p>

<p>I'm working on a Rails application that would allow friends to help track this type of arrangement. The core functionality of the app will be tracking the loans and payments between users and tallying them up.</p>

<p>One interesting challenge about tracking these loans and payments is that each transaction has to be reflected for both users but in opposite directions. For example, if a <code>user_a</code> loans <code>user_b</code> $10, the app must be able to tell <code>user_a</code> that he is owed $10 from <code>user_b</code> and tell <code>user_b</code> that he owes $10 to <code>user_a</code>. I set out to accomplish this in a way that would be intuitive and avoid duplicating transactions in the database. I landed on creating two models — User and Transaction — with a schema that looks like this:</p>

<p><img alt="Database schema for my Rails app" src="../../../../images/tracking_loans_and_payments_schema.svg" /></p>

<p>In the User and Transaction models, I set up some relationships: a transaction belongs to <code>from</code> and <code>to</code>, which are each users, and a user has many <code>from_transactions</code> and <code>to_transactions</code>. With two instance methods in the User model, I can track and total loans and payments between users.</p>

<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:from_transactions</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"from_id"</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Transaction"</span>
  <span class="n">has_many</span> <span class="ss">:to_transactions</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"to_id"</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Transaction"</span>

  <span class="k">def</span> <span class="nf">transactions_with</span><span class="p">(</span><span class="n">friend</span><span class="p">)</span>
    <span class="n">from_transactions</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">to_id: </span><span class="n">friend</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span> <span class="o">+</span> <span class="n">to_transactions</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">from_id: </span><span class="n">friend</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">owes</span><span class="p">(</span><span class="n">friend</span><span class="p">)</span>
    <span class="n">owes</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">from_transactions</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">to_id: </span><span class="n">friend</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">transaction</span><span class="o">|</span> <span class="n">owes</span> <span class="o">-=</span> <span class="n">transaction</span><span class="p">.</span><span class="nf">amount</span> <span class="p">}</span>
    <span class="n">to_transactions</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">from_id: </span><span class="n">friend</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">transaction</span><span class="o">|</span> <span class="n">owes</span> <span class="o">+=</span> <span class="n">transaction</span><span class="p">.</span><span class="nf">amount</span> <span class="p">}</span>
    <span class="n">owes</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Calling <code>user_a.transactions_with(user_b)</code> returns all of the transactions between <code>user_a</code> and <code>user_b</code>, both when <code>user_a</code> is the <code>from</code> user and when he is the <code>to</code> user. In a future iteration of this method, I'll sort the transactions so that the newest ones are returned first, but this serves as a good starting point.</p>

<p>Calling <code>user_a.owes(user_b)</code> returns the amount <code>user_a</code> owes <code>user_b</code> by subtracting each transaction on which <code>user_a</code> is the <code>from</code> user and adding each transaction on which he is the <code>to</code> user. For a loan, this means when <code>user_b</code> makes a $5 loan <code>to user_a</code>, <code>user_a.owes(user_b)</code> increases by $5 and <code>user_b.owes(user_a)</code> decreases by $5. <code>user_a</code> could settle his debt by making a payment back <code>to user_b</code>, which would decrease <code>user_a.owes(user_b)</code> and increase <code>user_b.owes(user_a)</code> by $5.</p>

      <p><i>August 04, 2015</i></p>
    </div>
  </article>
</div>

    <div class="footer">
      <h2>Get in touch</h2>
      <a href="mailto:nick.r.holden@gmail.com"><i class="fa fa-envelope-o"></i> nick.r.holden@gmail.com</a><br />
      <a href="https://github.com/nholden" target="_blank"><i class="fa fa-github"></i> nholden</a><br />
      <a href="https://www.linkedin.com/in/nickholden" target="_blank"><i class="fa fa-linkedin-square"></i> Nick Holden</a><br />
      <a href="https://www.twitter.com/nickyholden" target="_blank"><i class="fa fa-twitter-square"></i> @NickyHolden</a>
    </div>
  </body>
</html>
